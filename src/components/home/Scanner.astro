---
// Scanner section component - Website analysis tool
import Icon from '../icons/Icon.astro';
---

<section id="scanner" class="section section-dark">
  <div class="container">
    <div class="section-header reveal">
      <p class="section-label">Gratis verktøy</p>
      <h2>Sjekk nettsiden din <span class="text-accent">nå</span></h2>
      <p class="section-desc">Få en komplett analyse av hastighet, SEO og mobilvennlighet på sekunder.</p>
    </div>

    <div class="scanner-box reveal-scale">
      <form id="scannerForm" class="scanner-form">
        <label for="scannerUrl" class="sr-only">Skriv inn nettadresse</label>
        <input type="text" id="scannerUrl" placeholder="dinside.no" required>
        <button type="submit" class="btn btn-primary btn-lg">
          <span class="btn-text">Analyser gratis</span>
          <span class="btn-loading"><Icon name="spinner" size={14} class="spin" /> Analyserer...</span>
        </button>
      </form>
    </div>

    <!-- Resultater (skjult til skanning er ferdig) -->
    <div id="scannerResults" class="scanner-results" style="display: none;">
      <!-- Fylles dynamisk med JavaScript -->
    </div>
  </div>
</section>

<script>
  import { createListenerScope } from '../../utils/events';
  import { $, $id } from '../../utils/dom';
  import { escapeHtml, sanitizeDataAttr } from '../../utils/sanitize';
  import type {
    AnalysisResult,
    AnalysisDetail,
    CategoryResult,
    CategoryKey,
    QuickWin,
    Severity,
    StatusColor,
    CATEGORY_LABELS,
    CATEGORY_DESCRIPTIONS
  } from '../../types/api';
  import { validateAnalysisResult, getScoreColorClass } from '../../types/api';

  // Inline SVG icons (eliminates FontAwesome CDN dependency)
  const svgIcons: Record<string, string> = {
    'server': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>',
    'tachometer-alt': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10h-2a8 8 0 1 1-2.34-5.66l1.41-1.41A10 10 0 0 0 12 2z"/><path d="M12 12l4.95-4.95"/><circle cx="12" cy="12" r="2"/></svg>',
    'search': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
    'shield-alt': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
    'mobile-alt': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
    'universal-access': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="8" r="1"/><path d="M12 10v4"/><path d="M9 12h6"/><path d="M10 16l2-2 2 2"/></svg>',
    'chart-line': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-5 5"/></svg>',
    'check': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
    'check-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    'times': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    'times-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    'exclamation-triangle': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    'exclamation-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    'info-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
    'question-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    'trophy': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
    'thumbs-up': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>',
    'bolt': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    'chart-bar': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="12" width="4" height="8"/><rect x="10" y="8" width="4" height="12"/><rect x="17" y="4" width="4" height="16"/></svg>',
    'arrow-right': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
    'list': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
    'clipboard-list': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><path d="M9 14h.01"/><path d="M13 14h2"/><path d="M9 18h.01"/><path d="M13 18h2"/></svg>',
    'gift': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>',
    'file-alt': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
    'ban': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>',
    'calendar-check': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M9 16l2 2 4-4"/></svg>'
  };

  function icon(name: string): string {
    return svgIcons[name] || svgIcons['check'];
  }

  // Category labels and descriptions
  const categoryLabels: Record<CategoryKey, string> = {
    performance: 'Hastighet',
    seo: 'SEO',
    security: 'Sikkerhet',
    mobile: 'Mobilvennlig',
    accessibility: 'Tilgjengelighet'
  };

  const categoryDescs: Record<CategoryKey, string> = {
    performance: 'Hvor raskt siden laster',
    seo: 'Synlighet i Google-søk',
    security: 'Beskyttelse mot angrep',
    mobile: 'Fungerer på telefon/nettbrett',
    accessibility: 'Brukervennlig for alle'
  };

  // Scanner functionality
  const analysisSteps = [
    { iconName: 'server', text: 'Kobler til server...' },
    { iconName: 'tachometer-alt', text: 'Analyserer hastighet...' },
    { iconName: 'search', text: 'Sjekker SEO-elementer...' },
    { iconName: 'shield-alt', text: 'Evaluerer sikkerhet...' },
    { iconName: 'mobile-alt', text: 'Tester mobilvennlighet...' },
    { iconName: 'universal-access', text: 'Kontrollerer tilgjengelighet...' },
    { iconName: 'chart-line', text: 'Beregner total score...' }
  ];

  // Store listener scope for tooltip cleanup
  let tooltipScope: ReturnType<typeof createListenerScope> | null = null;

  function showAnalysisProgress(resultsDiv: HTMLElement): ReturnType<typeof setInterval> {
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `
      <div class="analysis-progress">
        <h4>Analyserer nettsiden din...</h4>
        <div class="progress-steps">
          ${analysisSteps.map((step, i) => `
            <div class="progress-step" data-step="${i}">
              ${icon(step.iconName)}
              <span>${escapeHtml(step.text)}</span>
              <span class="step-check">${icon('check')}</span>
            </div>
          `).join('')}
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill"></div>
        </div>
      </div>
    `;

    // Animate steps
    let currentStep = 0;
    const stepElements = resultsDiv.querySelectorAll('.progress-step');
    const progressBar = resultsDiv.querySelector('.progress-bar-fill') as HTMLElement | null;

    function activateStep(): void {
      if (currentStep < stepElements.length) {
        // Complete previous step
        if (currentStep > 0) {
          stepElements[currentStep - 1].classList.remove('active');
          stepElements[currentStep - 1].classList.add('complete');
        }
        // Activate current step
        stepElements[currentStep].classList.add('active');
        // Update progress bar with null check
        if (progressBar) {
          const progress = ((currentStep + 1) / stepElements.length) * 100;
          progressBar.style.width = progress + '%';
        }
        currentStep++;
      }
    }

    // Start animation
    activateStep();
    const stepInterval = setInterval(() => {
      activateStep();
      if (currentStep >= stepElements.length) {
        clearInterval(stepInterval);
      }
    }, 700);

    return stepInterval;
  }

  // Initialize scanner form
  function initScanner(): void {
    const form = $id('scannerForm') as HTMLFormElement | null;
    if (!form) return;

    form.addEventListener('submit', async (e: Event) => {
      e.preventDefault();
      const urlInput = $id('scannerUrl') as HTMLInputElement | null;
      const resultsDiv = $id('scannerResults');

      if (!urlInput || !resultsDiv) return;

      let url = urlInput.value.trim();

      // Auto-add https:// if missing
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }

      form.classList.add('loading');

      // Show progress animation
      const progressInterval = showAnalysisProgress(resultsDiv);

      try {
        // Add timeout using AbortController
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        const response = await fetch(`/api/analyze?url=${encodeURIComponent(url)}`, {
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        clearInterval(progressInterval);

        // Check response status before parsing
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Server-feil: ${response.status}`);
        }

        const data = await response.json();

        // Validate response structure
        if (!validateAnalysisResult(data)) {
          throw new Error('Ugyldig svar fra server');
        }

        if ('error' in data) {
          throw new Error(data.error);
        }

        // Small delay to let progress complete visually
        setTimeout(() => {
          displayResults(data);
        }, 500);
      } catch (error: unknown) {
        clearInterval(progressInterval);
        resultsDiv.style.display = 'block';

        let errorMessage = 'Kunne ikke analysere nettsiden. Sjekk at URLen er korrekt og prøv igjen.';

        if (error instanceof Error) {
          if (error.name === 'AbortError') {
            errorMessage = 'Forespørselen tok for lang tid. Prøv igjen senere.';
          } else {
            errorMessage = error.message;
          }
        }

        resultsDiv.innerHTML = `
          <div class="scanner-error">
            ${icon('exclamation-triangle')}
            <p>${escapeHtml(errorMessage)}</p>
          </div>
        `;
        form.classList.remove('loading');
      }
    });
  }

  function displayResults(data: AnalysisResult): void {
    const resultsDiv = $id('scannerResults');
    const form = $id('scannerForm') as HTMLFormElement | null;

    if (!resultsDiv || !form) return;

    form.classList.remove('loading');
    resultsDiv.style.display = 'block';

    // Count issues by severity
    const allDetails = Object.values(data.categories).flatMap((cat: CategoryResult) => cat.details || []);
    const criticalCount = allDetails.filter((d: AnalysisDetail) => d.severity === 'critical').length;
    const warningCount = allDetails.filter((d: AnalysisDetail) => d.severity === 'warning').length;
    const successCount = allDetails.filter((d: AnalysisDetail) => d.type === 'success').length;

    // Generate quick wins
    const quickWins = generateQuickWins(data);

    // Calculate potential score
    const potentialScore = Math.min(95, data.totalScore + Math.min(25, criticalCount * 8 + warningCount * 3));

    // Find weak areas for messaging
    const weakAreas = (Object.entries(data.categories) as [CategoryKey, CategoryResult][])
      .filter(([, v]) => v.score < 70)
      .map(([k]) => getCategoryLabel(k));

    const colorClass = getScoreColorClass(data.totalScore);

    resultsDiv.innerHTML = `
      <button class="scanner-close" data-action="close">
        ${icon('times')} Lukk resultater
      </button>
      <div class="score-overview">
        <div class="score-circle ${colorClass} animating">
          <span class="score-number">0</span>
        </div>
        <p>Total score av 100</p>
        <div class="score-summary">
          ${criticalCount > 0 ? `<span class="issue-badge critical">${criticalCount} kritiske</span>` : ''}
          ${warningCount > 0 ? `<span class="issue-badge warning">${warningCount} advarsler</span>` : ''}
          ${successCount > 0 ? `<span class="issue-badge success">${successCount} godkjent</span>` : ''}
        </div>
      </div>

      <div class="score-feedback ${colorClass}">
        <div class="feedback-icon">${getFeedbackIcon(data.totalScore)}</div>
        <div class="feedback-content">
          <h4>${escapeHtml(getFeedbackTitle(data.totalScore))}</h4>
          <p>${escapeHtml(generateFeedback(data))}</p>
        </div>
      </div>

      <div class="score-categories with-rings">
        ${(Object.entries(data.categories) as [CategoryKey, CategoryResult][]).map(([key, val]) => `
          <div class="score-category" data-category="${sanitizeDataAttr(key)}" data-action="filter-category">
            <div class="category-ring-container">
              <svg class="category-ring" viewBox="0 0 80 80">
                <circle class="ring-bg" cx="40" cy="40" r="36"></circle>
                <circle class="ring-progress ${val.status}" cx="40" cy="40" r="36" data-score="${val.score}"></circle>
              </svg>
              <span class="category-ring-value">${val.score}</span>
            </div>
            <div class="score-category-label">${escapeHtml(getCategoryLabel(key))}</div>
            <div class="score-category-desc">${escapeHtml(getCategoryDesc(key))}</div>
          </div>
        `).join('')}
      </div>

      ${quickWins.length > 0 ? `
      <div class="quick-wins">
        <h3>${icon('bolt')} Raskeste forbedringer</h3>
        <p class="quick-wins-subtitle">Disse endringene gir størst effekt med minst innsats</p>
        <div class="quick-wins-list">
          ${quickWins.slice(0, 5).map((win: QuickWin) => `
            <div class="quick-win-item">
              <div class="quick-win-icon">
                ${getCategoryIcon(win.category)}
              </div>
              <div class="quick-win-content">
                <p>${escapeHtml(win.message)}</p>
                <div class="quick-win-meta">
                  <span>${icon('clock')} ${escapeHtml(win.fixTime)}</span>
                  <span class="${win.impact === 'Høy' ? 'high-impact' : ''}">${icon('chart-line')} ${escapeHtml(win.impact)} effekt</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      ${data.benchmarks ? `
      <div class="benchmark-comparison">
        <h4>${icon('chart-bar')} Sammenligning med norsk gjennomsnitt</h4>
        <div class="benchmark-bars">
          ${(Object.entries(data.categories) as [CategoryKey, CategoryResult][]).map(([key, val]) => `
            <div class="benchmark-row">
              <span class="benchmark-label">${escapeHtml(getCategoryLabel(key))}</span>
              <div class="benchmark-bar-container">
                <div class="benchmark-bar yours" style="width: ${val.score}%">
                  <span>Du: ${val.score}</span>
                </div>
                <div class="benchmark-bar average" style="width: ${val.benchmark}%">
                  <span>Snitt: ${val.benchmark}</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      ${data.totalScore < 85 ? `
      <div class="improvement-potential">
        <div class="potential-visual">
          <div class="potential-score potential-current">
            <span class="score-value">${data.totalScore}</span>
            <span class="score-label">Nå</span>
          </div>
          <div class="potential-arrow">
            ${icon('arrow-right')}
            ${icon('arrow-right')}
          </div>
          <div class="potential-score potential-target">
            <span class="score-value">${potentialScore}</span>
            <span class="score-label">Potensial</span>
          </div>
        </div>
        <div class="potential-content">
          <h4>Vi kan løfte scoren din med opptil ${potentialScore - data.totalScore} poeng</h4>
          <p>Basert på analysen kan vi forbedre ${weakAreas.length > 0 ? weakAreas.join(', ').toLowerCase() : 'flere områder'} som direkte påvirker synlighet og konvertering.</p>
          <a href="#kontakt" class="btn btn-primary">Få gratis forbedringsplan</a>
        </div>
      </div>
      ` : ''}

      <div class="scanner-filters">
        <button class="filter-btn active" data-action="filter-severity" data-filter="all">
          ${icon('list')} Vis alle
        </button>
        ${criticalCount > 0 ? `
        <button class="filter-btn filter-critical" data-action="filter-severity" data-filter="critical">
          ${icon('times-circle')} Kun kritiske (${criticalCount})
        </button>
        ` : ''}
        ${warningCount > 0 ? `
        <button class="filter-btn filter-warning" data-action="filter-severity" data-filter="warning">
          ${icon('exclamation-triangle')} Kun advarsler (${warningCount})
        </button>
        ` : ''}
        ${successCount > 0 ? `
        <button class="filter-btn filter-success" data-action="filter-severity" data-filter="success">
          ${icon('check-circle')} Kun godkjent (${successCount})
        </button>
        ` : ''}
      </div>

      <div class="scanner-details">
        <h3>${icon('clipboard-list')} Detaljert analyse <span class="filter-label"></span></h3>
        ${(Object.entries(data.categories) as [CategoryKey, CategoryResult][]).map(([key, val]) => `
          <div class="detail-section collapsible" data-category="${sanitizeDataAttr(key)}">
            <div class="detail-header" data-action="toggle-section">
              <span class="detail-icon">${getCategoryIcon(key)}</span>
              <span class="detail-title">${escapeHtml(getCategoryLabel(key))}</span>
              <span class="detail-score ${val.status}">${val.score}/100</span>
            </div>
            <div class="detail-items">
              ${(val.details || []).map((detail: AnalysisDetail) => `
                <div class="detail-item ${detail.severity || detail.type || ''}" data-severity="${sanitizeDataAttr(detail.severity || detail.type || '')}">
                  <span class="detail-item-icon">${getDetailIcon(detail)}</span>
                  <span class="detail-item-text">${escapeHtml(detail.message)}</span>
                  ${getTooltip(detail.message) ? `
                  <button class="info-tooltip" type="button" aria-label="Mer informasjon">
                    ${icon('question-circle')}
                    <div class="tooltip-content">
                      <strong>Hvorfor dette er viktig</strong>
                      ${escapeHtml(getTooltip(detail.message) || '')}
                    </div>
                  </button>
                  ` : ''}
                </div>
              `).join('')}
              ${(val.details || []).length === 0 ? `<div class="detail-item info" data-severity="info"><span class="detail-item-icon">${icon('check')}</span><span class="detail-item-text">Ingen problemer funnet</span></div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>

      <div class="scanner-cta enhanced">
        <div class="cta-badge">
          ${icon('gift')} Gratis tilbud
        </div>
        <h3>Få en personlig forbedringsplan</h3>
        <p>Vi går gjennom analysen med deg og lager en konkret plan for å forbedre nettsiden din. Helt gratis, ingen forpliktelser.</p>

        <div class="cta-trust-signals">
          <div class="trust-signal">
            ${icon('clock')}
            <span>15 min uforpliktende samtale</span>
          </div>
          <div class="trust-signal">
            ${icon('file-alt')}
            <span>Skriftlig rapport inkludert</span>
          </div>
          <div class="trust-signal">
            ${icon('ban')}
            <span>Ingen bindingstid</span>
          </div>
        </div>

        <a href="#kontakt" class="btn btn-primary btn-lg">
          ${icon('calendar-check')} Book gratis gjennomgang
        </a>
      </div>
    `;

    // Animate score counting
    const scoreElement = resultsDiv.querySelector('.score-number');
    if (scoreElement) {
      animateScore(scoreElement as HTMLElement, data.totalScore);
    }

    // Animate category rings
    setTimeout(() => {
      resultsDiv.querySelectorAll('.ring-progress').forEach((ring: Element) => {
        const ringEl = ring as HTMLElement;
        const scoreAttr = ringEl.dataset.score;
        if (scoreAttr) {
          const score = parseInt(scoreAttr, 10);
          if (!Number.isNaN(score)) {
            const circumference = 2 * Math.PI * 36;
            const offset = circumference - (score / 100) * circumference;
            ringEl.style.strokeDashoffset = String(offset);
          }
        }
      });
    }, 300);

    // Expand first detail section
    setTimeout(() => {
      const firstSection = resultsDiv.querySelector('.detail-section.collapsible');
      if (firstSection) firstSection.classList.add('expanded');
    }, 800);

    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Setup event delegation and tooltips
    setupEventDelegation(resultsDiv);
    setupTooltips();
  }

  // Event delegation for all interactive elements (replaces inline onclick)
  function setupEventDelegation(container: HTMLElement): void {
    // Direct event listeners for toggle sections (more reliable)
    container.querySelectorAll('[data-action="toggle-section"]').forEach(header => {
      header.addEventListener('click', () => {
        const section = header.closest('.detail-section');
        if (section) {
          section.classList.toggle('expanded');
        }
      });
    });

    container.addEventListener('click', (e: MouseEvent) => {
      const target = e.target as HTMLElement;

      // Close button
      const closeBtn = target.closest('[data-action="close"]');
      if (closeBtn) {
        container.style.display = 'none';
        return;
      }

      // Filter by category
      const categoryBox = target.closest('[data-action="filter-category"]') as HTMLElement | null;
      if (categoryBox) {
        const category = categoryBox.dataset.category;
        if (category) filterByCategory(category as CategoryKey);
        return;
      }

      // Filter by severity
      const filterBtn = target.closest('[data-action="filter-severity"]') as HTMLElement | null;
      if (filterBtn) {
        const severity = filterBtn.dataset.filter;
        if (severity) filterResults(severity, filterBtn);
        return;
      }
    });
  }

  // Position tooltips with fixed positioning to avoid overflow issues
  function setupTooltips(): void {
    // Cleanup previous tooltip listeners
    tooltipScope?.cleanup();
    tooltipScope = createListenerScope();

    document.querySelectorAll('.info-tooltip').forEach(btn => {
      const tooltip = btn.querySelector('.tooltip-content') as HTMLElement | null;
      if (!tooltip) return;

      tooltipScope!.add(btn as HTMLElement, 'mouseenter', () => {
        const rect = btn.getBoundingClientRect();
        const tooltipWidth = 300;

        // Position above the button, centered
        let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
        const top = rect.top - 10;

        // Keep within viewport
        if (left < 10) left = 10;
        if (left + tooltipWidth > window.innerWidth - 10) {
          left = window.innerWidth - tooltipWidth - 10;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.bottom = (window.innerHeight - top) + 'px';
        tooltip.style.top = 'auto';
      });
    });
  }

  // Animate score counting up
  function animateScore(element: HTMLElement, targetScore: number, duration = 1500): void {
    let startTime: number | null = null;
    const startScore = 0;

    function animate(timestamp: number): void {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const currentScore = Math.round(startScore + (targetScore - startScore) * easeOut);
      element.textContent = String(currentScore);

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }
    requestAnimationFrame(animate);
  }

  // Generate quick wins from analysis data
  function generateQuickWins(data: AnalysisResult): QuickWin[] {
    const quickWins: QuickWin[] = [];

    const fixTimeMap: Record<string, string> = {
      'title': '5 min',
      'meta description': '5 min',
      'alt': '10 min',
      'H1': '5 min',
      'viewport': '2 min',
      'HTTPS': '30 min',
      'canonical': '5 min',
      'lang': '2 min',
      'Open Graph': '15 min',
      'lazy': '15 min',
      'async': '10 min',
      'defer': '10 min'
    };

    const impactMap: Record<Severity, QuickWin['impact']> = {
      'critical': 'Høy',
      'warning': 'Medium',
      'info': 'Lav'
    };

    (Object.entries(data.categories) as [CategoryKey, CategoryResult][]).forEach(([cat, val]) => {
      (val.details || []).forEach((detail: AnalysisDetail) => {
        if (detail.severity === 'critical' || detail.severity === 'warning') {
          let fixTime = '15 min';
          for (const [key, time] of Object.entries(fixTimeMap)) {
            if (detail.message.toLowerCase().includes(key.toLowerCase())) {
              fixTime = time;
              break;
            }
          }

          quickWins.push({
            category: cat,
            message: detail.message,
            severity: detail.severity,
            fixTime: fixTime,
            impact: impactMap[detail.severity] || 'Medium'
          });
        }
      });
    });

    // Sort by impact (critical first) then by fix time
    return quickWins.sort((a, b) => {
      if (a.severity === 'critical' && b.severity !== 'critical') return -1;
      if (b.severity === 'critical' && a.severity !== 'critical') return 1;
      return 0;
    });
  }

  // Get tooltip explanation for common issues
  function getTooltip(message: string): string | null {
    const tooltips: Record<string, string> = {
      'title': 'Title-taggen vises i Google-søk og nettleser-faner. En god title øker klikk fra søkeresultater.',
      'meta description': 'Meta description vises under title i Google. En god beskrivelse øker klikkraten betydelig.',
      'H1': 'H1-overskriften forteller Google hva siden handler om. Viktig for rangering på relevante søkeord.',
      'alt': 'Alt-tekst hjelper søkemotorer forstå bildene dine og er kritisk for synshemmede brukere.',
      'HTTPS': 'HTTPS beskytter brukerdata og er en rangeringsfaktor i Google. Uten HTTPS vises "Ikke sikker" i nettleseren.',
      'viewport': 'Viewport-meta sikrer at siden vises korrekt på mobil. Uten den vil siden zoomes ut og være vanskelig å bruke.',
      'canonical': 'Canonical URL forteller Google hvilken versjon av siden som er "hovedversjonen" og unngår duplikatinnhold.',
      'Open Graph': 'Open Graph-tags bestemmer hvordan siden ser ut når den deles på Facebook, LinkedIn og andre sosiale medier.',
      'lazy': 'Lazy loading utsetter lasting av bilder til de trengs, noe som gjør siden mye raskere.',
      'responstid': 'Server-responstid påvirker både brukeropplevelse og Google-rangering. Trege sider mister besøkende.',
      'render-blokkerende': 'Render-blokkerende scripts stopper siden fra å vises til de er lastet. Async/defer løser dette.'
    };

    for (const [key, tooltip] of Object.entries(tooltips)) {
      if (message.toLowerCase().includes(key.toLowerCase())) {
        return tooltip;
      }
    }
    return null;
  }

  function getFeedbackIcon(score: number): string {
    if (score >= 90) return icon('trophy');
    if (score >= 70) return icon('thumbs-up');
    if (score >= 50) return icon('exclamation-circle');
    return icon('times-circle');
  }

  function getFeedbackTitle(score: number): string {
    if (score >= 90) return 'Utmerket! Nettsiden din er i toppklasse';
    if (score >= 70) return 'Bra jobbet! Men det er rom for forbedring';
    if (score >= 50) return 'Nettsiden trenger oppmerksomhet';
    return 'Kritisk! Nettsiden har alvorlige mangler';
  }

  function generateFeedback(data: AnalysisResult): string {
    const categories = data.categories;
    const weakAreas: Array<{ label: string; score: number; priority: string }> = [];
    const strongAreas: string[] = [];
    const okAreas: Array<{ label: string; score: number }> = [];

    // Finn svake, ok og sterke områder
    (Object.entries(categories) as [CategoryKey, CategoryResult][]).forEach(([key, val]) => {
      const label = getCategoryLabel(key);
      if (val.score < 50) {
        weakAreas.push({ label, score: val.score, priority: 'critical' });
      } else if (val.score < 70) {
        weakAreas.push({ label, score: val.score, priority: 'warning' });
      } else if (val.score < 90) {
        okAreas.push({ label, score: val.score });
      } else {
        strongAreas.push(label);
      }
    });

    // Sorter svake områder etter score (lavest først)
    weakAreas.sort((a, b) => a.score - b.score);

    let feedback = '';

    if (data.totalScore >= 90) {
      feedback = 'Gratulerer! Nettsiden din scorer høyt på alle viktige områder. ';
      if (strongAreas.length > 0) {
        feedback += `Spesielt bra på ${strongAreas.slice(0, 2).join(' og ')}.`;
      }
      feedback += ' Fortsett det gode arbeidet og hold siden oppdatert.';
    } else if (data.totalScore >= 70) {
      feedback = 'Nettsiden din presterer bra totalt sett. ';
      if (weakAreas.length > 0) {
        feedback += `${weakAreas.map(w => w.label).join(' og ')} kan forbedres for enda bedre resultater.`;
      } else if (okAreas.length > 0) {
        feedback += `Små justeringer på ${okAreas.slice(0, 2).map(a => a.label.toLowerCase()).join(' og ')} kan løfte siden til toppnivå.`;
      } else {
        feedback += 'Fortsett å vedlikeholde siden for å beholde de gode resultatene.';
      }
    } else if (data.totalScore >= 50) {
      feedback = 'Nettsiden din har flere områder som trenger forbedring. ';
      if (weakAreas.length > 0) {
        const criticalAreas = weakAreas.filter(w => w.priority === 'critical');
        if (criticalAreas.length > 0) {
          feedback += `${criticalAreas.map(w => w.label).join(' og ')} krever oppmerksomhet. `;
        } else {
          feedback += `${weakAreas.map(w => w.label).join(' og ')} bør prioriteres. `;
        }
        feedback += 'Dette påvirker hvordan kunder finner og opplever siden din.';
      }
    } else {
      feedback = 'Nettsiden din har alvorlige problemer som kan skade virksomheten din. ';
      if (weakAreas.length > 0) {
        feedback += `${weakAreas.slice(0, 3).map(w => w.label).join(', ')} scorer kritisk lavt. `;
      }
      feedback += 'Vi anbefaler å ta tak i dette så raskt som mulig.';
    }

    return feedback;
  }

  function getCategoryLabel(key: CategoryKey): string {
    return categoryLabels[key] || key;
  }

  function getCategoryDesc(key: CategoryKey): string {
    return categoryDescs[key] || '';
  }

  function getCategoryIcon(key: CategoryKey): string {
    const categoryIcons: Record<CategoryKey, string> = {
      performance: icon('tachometer-alt'),
      seo: icon('search'),
      security: icon('shield-alt'),
      mobile: icon('mobile-alt'),
      accessibility: icon('universal-access')
    };
    return categoryIcons[key] || icon('check');
  }

  function getDetailIcon(detail: AnalysisDetail): string {
    if (detail.type === 'success') return icon('check-circle');
    if (detail.severity === 'critical') return icon('times-circle');
    if (detail.severity === 'warning') return icon('exclamation-triangle');
    return icon('info-circle');
  }

  // Filter by category (click on category box)
  function filterByCategory(category: CategoryKey): void {
    const resultsDiv = $id('scannerResults');
    if (!resultsDiv) return;

    const sections = resultsDiv.querySelectorAll('.detail-section');
    const categoryBoxes = resultsDiv.querySelectorAll('.score-category');
    const filterBtns = resultsDiv.querySelectorAll('.filter-btn');
    const filterLabel = resultsDiv.querySelector('.filter-label');

    // Check if already filtered to this category
    const categoryBox = resultsDiv.querySelector(`.score-category[data-category="${sanitizeDataAttr(category)}"]`);
    const isAlreadyFiltered = categoryBox?.classList.contains('active');

    // Reset all category boxes
    categoryBoxes.forEach(box => box.classList.remove('active'));

    // Reset filter buttons
    filterBtns.forEach(btn => btn.classList.remove('active'));
    const firstFilterBtn = resultsDiv.querySelector('.filter-btn');
    firstFilterBtn?.classList.add('active');

    if (isAlreadyFiltered) {
      // Show all
      sections.forEach(section => {
        (section as HTMLElement).style.display = 'block';
        section.querySelectorAll('.detail-item').forEach(item => (item as HTMLElement).style.display = 'flex');
      });
      if (filterLabel) filterLabel.textContent = '';
    } else {
      // Filter to specific category
      categoryBoxes.forEach(box => {
        if ((box as HTMLElement).dataset.category === category) box.classList.add('active');
      });

      sections.forEach(section => {
        if ((section as HTMLElement).dataset.category === category) {
          (section as HTMLElement).style.display = 'block';
          section.querySelectorAll('.detail-item').forEach(item => (item as HTMLElement).style.display = 'flex');
        } else {
          (section as HTMLElement).style.display = 'none';
        }
      });

      if (filterLabel) filterLabel.textContent = `- ${getCategoryLabel(category)}`;
    }

    const detailsSection = resultsDiv.querySelector('.scanner-details');
    detailsSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Filter by severity (critical, warning, success)
  function filterResults(severity: string, clickedBtn: HTMLElement): void {
    const resultsDiv = $id('scannerResults');
    if (!resultsDiv) return;

    const sections = resultsDiv.querySelectorAll('.detail-section');
    const items = resultsDiv.querySelectorAll('.detail-item');
    const filterBtns = resultsDiv.querySelectorAll('.filter-btn');
    const categoryBoxes = resultsDiv.querySelectorAll('.score-category');
    const filterLabel = resultsDiv.querySelector('.filter-label');

    // Reset category filter
    categoryBoxes.forEach(box => box.classList.remove('active'));

    // Update active button
    filterBtns.forEach(btn => btn.classList.remove('active'));
    clickedBtn.classList.add('active');

    if (severity === 'all') {
      // Show all
      sections.forEach(section => (section as HTMLElement).style.display = 'block');
      items.forEach(item => (item as HTMLElement).style.display = 'flex');
      if (filterLabel) filterLabel.textContent = '';
    } else {
      // Filter by severity
      const severityLabels: Record<string, string> = {
        critical: 'Kritiske',
        warning: 'Advarsler',
        success: 'Godkjent'
      };
      if (filterLabel) filterLabel.textContent = `- ${severityLabels[severity] || ''}`;

      sections.forEach(section => {
        const matchingItems = section.querySelectorAll(`.detail-item[data-severity="${sanitizeDataAttr(severity)}"]`);
        const allItems = section.querySelectorAll('.detail-item');

        allItems.forEach(item => {
          if ((item as HTMLElement).dataset.severity === severity) {
            (item as HTMLElement).style.display = 'flex';
          } else {
            (item as HTMLElement).style.display = 'none';
          }
        });

        // Hide section if no matching items
        (section as HTMLElement).style.display = matchingItems.length > 0 ? 'block' : 'none';
      });
    }
  }

  // Cleanup on page navigation
  document.addEventListener('astro:before-swap', () => {
    tooltipScope?.cleanup();
    tooltipScope = null;
  });

  // Initialize
  initScanner();
  document.addEventListener('astro:page-load', initScanner);
</script>
