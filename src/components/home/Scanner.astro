---
// Scanner section component - Website analysis tool
import Icon from '../icons/Icon.astro';
---

<section id="scanner" class="section section-dark">
  <div class="container">
    <div class="section-header reveal">
      <p class="section-label">Gratis verktøy</p>
      <h2>Sjekk nettsiden din <span class="text-accent">nå</span></h2>
      <p class="section-desc">Få en komplett analyse av hastighet, SEO og mobilvennlighet på sekunder.</p>
    </div>

    <div class="scanner-box reveal-scale">
      <form id="scannerForm" class="scanner-form">
        <label for="scannerUrl" class="sr-only">Skriv inn nettadresse</label>
        <input type="text" id="scannerUrl" placeholder="dinside.no" required>
        <button type="submit" class="btn btn-primary btn-lg">
          <span class="btn-text">Analyser gratis</span>
          <span class="btn-loading"><Icon name="spinner" size={14} class="spin" /> Analyserer...</span>
        </button>
      </form>
    </div>

    <!-- Resultater (skjult til skanning er ferdig) -->
    <div id="scannerResults" class="scanner-results" style="display: none;">
      <!-- Fylles dynamisk med JavaScript -->
    </div>
  </div>
</section>

<script>
  // Lazy-load scanner logic when section becomes visible
  // This reduces initial JS bundle by ~28KB
  let scannerInitialized = false;

  async function initScannerWhenVisible(): Promise<void> {
    if (scannerInitialized) return;

    const section = document.getElementById('scanner');
    if (!section) return;

    const observer = new IntersectionObserver(async (entries) => {
      if (entries[0].isIntersecting && !scannerInitialized) {
        scannerInitialized = true;
        observer.disconnect();

        // Dynamically import scanner logic
        const { initScanner } = await import('./scanner-logic');
        initScanner();
      }
    }, { rootMargin: '200px' }); // Load 200px before visible

    observer.observe(section);
  }

  // Initialize on page load
  initScannerWhenVisible();

  // Re-initialize on View Transitions navigation
  document.addEventListener('astro:page-load', () => {
    scannerInitialized = false;
    initScannerWhenVisible();
  });
</script>
